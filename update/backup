#!/bin/bash
# My Telegram : https://t.me/hokagevpnpremium
# ==========================================
# Modern Color Scheme
RED='\033[1;31m'
NC='\033[0m'
GREEN='\033[1;32m'
ORANGE='\033[1;33m'
BLUE='\033[1;34m'
PURPLE='\033[1;35m'
CYAN='\033[1;36m'
LIGHT='\033[1;37m'
DARK='\033[1;30m'
# ==========================================

# Function to display modern progress spinner
spinner() {
    local pid=$!
    local delay=0.1
    local spinstr='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " ${PURPLE}[%c]${NC}  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

# Function to display header
display_header() {
    clear
    echo -e "${PURPLE}"
    echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo -e "â•‘          ğŸ›¡ï¸ VPS BACKUP SYSTEM ğŸ›¡ï¸           â•‘"
    echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo -e "â•‘      Automated Backup with Cloud Storage     â•‘"
    echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# Getting bot info
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
export TIME="10"
export URL="https://api.telegram.org/bot$KEY/sendMessage"

display_header
IP=$(curl -sS ipv4.icanhazip.com)
domain=$(cat /etc/xray/domain)
date=$(date +"%Y-%m-%d")
timestamp=$(date +"%Y%m%d_%H%M%S")

# Backup directory and file
BACKUP_DIR="/root/backup_${timestamp}"
BACKUP_FILE="/root/backup_${IP}_${timestamp}.zip"
BACKUP_FILE_NAME="backup_${IP}_${timestamp}.zip"

# Create backup directory
echo -e "${BLUE}ğŸ”¹ Creating backup directory...${NC}"
mkdir -p "$BACKUP_DIR" || {
    echo -e "${RED}âŒ Failed to create backup directory${NC}"
    exit 1
}

# Copy system files with progress
echo -e "${BLUE}ğŸ”¹ Copying system files...${NC}"
important_files=(
    "/etc/passwd"
    "/etc/group"
    "/etc/shadow"
    "/etc/gshadow"
    "/etc/crontab"
)

for file in "${important_files[@]}"; do
    if [ -f "$file" ]; then
        cp "$file" "$BACKUP_DIR/" && echo -e "${GREEN}âœ” Successfully copied $file${NC}" || echo -e "${RED}âŒ Failed to copy $file${NC}"
    else
        echo -e "${ORANGE}âš  File $file not found${NC}"
    fi
done

# Copy directories
echo -e "${BLUE}ğŸ”¹ Copying directories...${NC}"
directories=(
    "/var/lib/kyt/"
    "/etc/xray"
    "/var/www/html/"
)

for dir in "${directories[@]}"; do
    if [ -d "$dir" ]; then
        cp -r "$dir" "$BACKUP_DIR/$(basename "$dir")" && echo -e "${GREEN}âœ” Successfully copied $dir${NC}" || echo -e "${RED}âŒ Failed to copy $dir${NC}"
    else
        echo -e "${ORANGE}âš  Directory $dir not found${NC}"
    fi
done

# Create ZIP archive
echo -e "${BLUE}ğŸ”¹ Creating ZIP archive...${NC}"
cd "$BACKUP_DIR" || {
    echo -e "${RED}âŒ Failed to enter backup directory${NC}"
    exit 1
}

zip -r "$BACKUP_FILE" . > /dev/null 2>&1 &
spinner
if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Failed to create ZIP backup file${NC}"
    exit 1
else
    echo -e "${GREEN}âœ” ZIP backup file created: $BACKUP_FILE${NC}"
fi

# Upload to Google Drive
echo -e "${BLUE}ğŸ”¹ Uploading to Google Drive...${NC}"
rclone copy "$BACKUP_FILE" dr:backup/ > /dev/null 2>&1 &
spinner
if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Failed to upload backup to Google Drive${NC}"
    echo -e "${ORANGE}ğŸ”¹ Checking rclone configuration...${NC}"
    rclone config show
    exit 1
else
    echo -e "${GREEN}âœ” Upload to Google Drive successful${NC}"
fi

# Get shareable link
echo -e "${BLUE}ğŸ”¹ Generating download link...${NC}"
url=$(rclone link dr:backup/"$BACKUP_FILE_NAME" 2>/dev/null)
if [[ "$url" =~ "id=" ]]; then
    id=$(echo "$url" | grep -oP 'id=\K[^&]+')
    link="https://drive.google.com/u/4/uc?id=${id}&export=download"
    echo -e "${GREEN}âœ” Backup link: $link${NC}"
else
    echo -e "${RED}âŒ Failed to get Google Drive link${NC}"
    link="Not available"
fi

# Send Telegram notification
echo -e "${BLUE}ğŸ”¹ Sending Telegram notification...${NC}"
TEXT="
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>   ğŸ”„ BACKUP NOTIFICATION ğŸ”„</b>
<b>      VPS Backup Details</b>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>ğŸ–¥ï¸ IP VPS  :</b> <code>${IP} </code>
<b>ğŸŒ DOMAIN :</b> <code>${domain}</code>
<b>ğŸ“… Date   :</b> <code>$date</code>
<b>â° Time   :</b> <code>$(date +"%H:%M:%S")</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<b>ğŸ—„ï¸ Backup File :</b> <code>$BACKUP_FILE_NAME</code>
<b>ğŸ”— Backup Link:</b> <code>$link</code>
<code>â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡</code>
<code>Copy the link to restore on a new VPS</code>
<code>ğŸ¤– Bot : @RosyVpn</code>
"

curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" "$URL" >/dev/null && echo -e "${GREEN}âœ” Telegram notification sent${NC}" || echo -e "${RED}âŒ Failed to send Telegram notification${NC}"

# Clean up
echo -e "${BLUE}ğŸ”¹ Cleaning temporary directory...${NC}"
rm -rf "$BACKUP_DIR" && echo -e "${GREEN}âœ” Temporary directory cleaned${NC}" || echo -e "${RED}âŒ Failed to clean temporary directory${NC}"

# Display final information
display_header
echo -e "${GREEN}"
echo -e "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "â•‘               BACKUP COMPLETE                â•‘"
echo -e "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo -e "â•‘  IP VPS        : $IP"
echo -e "â•‘  Backup File   : $BACKUP_FILE_NAME"
echo -e "â•‘  Backup Link   : $link"
echo -e "â•‘  Date          : $date"
echo -e "â•‘  Time          : $(date +"%H:%M:%S")"
echo -e "â•‘  Local Path    : $BACKUP_FILE"
echo -e "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo -e "${GREEN}âœ” Backup file saved at: ${BACKUP_FILE}${NC}"
echo -e "\n${ORANGE}Press Enter to continue...${NC}"
read -p ""

echo -e "${GREEN}Please copy the link to restore on a new VPS${NC}"
