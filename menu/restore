#!/bin/bash
# Restore Script for HOKAGEVPN
# ==========================================
# Color
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'
# ==========================================

clear
echo -e "${GREEN}==========================================${NC}"
echo -e "${GREEN}          HOKAGE VPN RESTORE TOOL          ${NC}"
echo -e "${GREEN}==========================================${NC}"
echo ""

# Check if running as root
if [ "$(id -u)" != "0" ]; then
   echo -e "${RED}Error: This script must be run as root${NC}" 1>&2
   exit 1
fi

# Ask for backup file
echo -e "${ORANGE}Please enter the full path to your backup ZIP file:${NC}"
read -p "Path: " backup_file

# Verify backup file exists
if [ ! -f "$backup_file" ]; then
    echo -e "${RED}Error: Backup file not found!${NC}"
    exit 1
fi

# Ask for confirmation
echo -e "${RED}WARNING: This will overwrite existing system files!${NC}"
read -p "Are you sure you want to restore from this backup? (y/n) " confirm
if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo -e "${ORANGE}Restore cancelled.${NC}"
    exit 0
fi

# Create temporary restore directory
temp_dir="/root/restore_temp"
mkdir -p "$temp_dir"

# Extract backup
echo -e "${GREEN}Extracting backup file...${NC}"
unzip -o "$backup_file" -d "$temp_dir" > /dev/null 2>&1

if [ ! -d "$temp_dir/backup" ]; then
    echo -e "${RED}Error: Invalid backup file structure!${NC}"
    rm -rf "$temp_dir"
    exit 1
fi

# Restore system files
echo -e "${GREEN}Restoring system files...${NC}"
cp "$temp_dir/backup/passwd" /etc/
cp "$temp_dir/backup/group" /etc/
cp "$temp_dir/backup/shadow" /etc/
cp "$temp_dir/backup/gshadow" /etc/
cp "$temp_dir/backup/crontab" /etc/

# Restore xray configuration
echo -e "${GREEN}Restoring Xray configuration...${NC}"
if [ -d "$temp_dir/backup/xray" ]; then
    rm -rf /etc/xray
    cp -r "$temp_dir/backup/xray" /etc/
fi

# Restore web files
echo -e "${GREEN}Restoring web files...${NC}"
if [ -d "$temp_dir/backup/html" ]; then
    rm -rf /var/www/html
    cp -r "$temp_dir/backup/html" /var/www/
fi

# Restore kyt data
echo -e "${GREEN}Restoring kyt data...${NC}"
if [ -d "$temp_dir/backup/kyt" ]; then
    rm -rf /var/lib/kyt
    cp -r "$temp_dir/backup/kyt" /var/lib/
fi

# Clean up
rm -rf "$temp_dir"

# Set proper permissions
echo -e "${GREEN}Setting permissions...${NC}"
chmod 644 /etc/passwd /etc/group /etc/shadow /etc/gshadow /etc/crontab
chmod -R 755 /etc/xray
chown -R nobody:nogroup /etc/xray
chown -R www-data:www-data /var/www/html
chmod -R 755 /var/www/html

echo -e "${GREEN}==========================================${NC}"
echo -e "${GREEN}   RESTORE PROCESS COMPLETED SUCCESSFULLY  ${NC}"
echo -e "${GREEN}==========================================${NC}"
echo -e "${ORANGE}Note: You may need to restart services manually:${NC}"
echo -e "1. Xray services"
echo -e "2. Web server (nginx/apache)"
echo -e "3. Other affected services"
echo ""
echo -e "${GREEN}To restart Xray:${NC}"
echo -e "systemctl restart xray"
echo -e "systemctl restart xray@*"
echo ""
echo -e "${GREEN}To restart web server:${NC}"
echo -e "systemctl restart nginx"
echo -e "or"
echo -e "systemctl restart apache2"
